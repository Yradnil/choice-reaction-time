{{ block title }}
SART MT
{{ endblock }}
{{ block content }}

{% load otree static %}
<link rel="stylesheet" href="{% static 'global/style1.css' %}"/>

<body>
  <div class="circle-container">
    <div class="circle-button" id="center-circle">3</div>
    <div class="circle-button" id="hold-button"></div>
  </div>

  <script>
    const centerCircle = document.getElementById('center-circle');
    const holdButton = document.getElementById('hold-button');

    const colors = ['#FFCC00', '#90D050', '#3C5DAE', '#7A8DBE', '#005000']; // last = green
    let currentColor = '';
    let isGreen = false;
    let showingFeedback = false;
    let intervalId = null;
    let trialIndex = 0;
    let cycleStarted = false;
    let rtStartTime = 0;
    let lastClick = performance.now(); 
    let colorCycleInterval = null;
    let inputEnabled = false;
    let awaitingResponse = false;
    let missTimeout = null;
    let timeoutId = null;
    let rt = 0;

    function startTrial() {
      startColorCycle();
    }

    function startColorCycle() {
      showNextStimulus();
    }

    function showNextStimulus() {
      if (showingFeedback) return;

      clearTimeout(missTimeout);
      inputEnabled = true;

      const colorIndex = Math.floor(Math.random() * colors.length);
      currentColor = colors[colorIndex];
      isGreen = currentColor === "#005000";

      centerCircle.style.backgroundColor = currentColor;
      centerCircle.innerText = "3";

      stimulusShownAt = isGreen ? performance.now() : null;
      awaitingResponse = isGreen;

      if (isGreen) {
        rtStartTime = performance.now();
        missTimeout = setTimeout(() => {
          if (awaitingResponse) {
            awaitingResponse = false;
            inputEnabled = false;
            showMessage("Missed!");
          }
        }, 2000);
      }

      // Instead of setInterval, chain next call manually:
      timeoutId = setTimeout(() => {
        if (!showingFeedback) {
          showNextStimulus();
        }
      }, 2000);
    }

    function showMessage(message) {
      showingFeedback = true;
      clearInterval(colorCycleInterval);
      clearTimeout(missTimeout);
      inputEnabled = false;

      centerCircle.innerText = message;

      setTimeout(() => {
        showingFeedback = false;
        resetTrial();
      }, 1000); // 1s feedback duration
    }

    function resetTrial() {
      clearTimeout(timeoutId);
      isGreen = false;
      centerCircle.style.backgroundColor = "gray";
      centerCircle.innerText = "";
    }

    function handleResponse() {
      rt = performance.now() - lastClick;
      if (showingFeedback || !cycleStarted) return; 
      cycleStarted = false;
      if (isGreen) {
        showMessage('Correct!');
        liveSend({ response_time: rt, trial_index: trialIndex });
        trialIndex++;
      } else {
        showMessage('Wrong!');
      }
    }

    centerCircle.addEventListener('click', handleResponse);

    holdButton.addEventListener('mousedown', () => {
      if (cycleStarted) return;

      cycleStarted = true;
      holdButton.style.backgroundColor = 'gray';
      startTrial();
    });

    holdButton.addEventListener('mouseup', () => {
      lastClick = performance.now();
      const rtLeave = performance.now() - rtStartTime
      liveSend({ leave_time: rtLeave, trial_index: trialIndex });
      if (!isGreen) {
        showMessage('Too early!');
        cycleStarted = false;
      }
      holdButton.style.backgroundColor = 'white';
    });
  </script>

</body>

{{ formfields }}
{{ next_button }}
{{ endblock }}