{{ block title }} SART {{ endblock }} {{ block content }} {% load otree static
%}
<link rel="stylesheet" href="{% static 'global/style1.css' %}" />

<body>
  <div class="circle-container">
    <div class="circle-button" id="center-circle">3</div>
  </div>

  <script>
    const centerCircle = document.getElementById("center-circle");
    const colors = ["#FFCC00", "#90D050", "#3C5DAE", "#7A8DBE", "#005000"]; // last one is green

    let currentColor = "";
    let isGreen = false;
    let showingFeedback = false;
    let stimulusShownAt = null;
    let trialIndex = 0;
    let missTimeout = null;
    let inputEnabled = false;
    let awaitingResponse = false;
    let timeoutId = null;

    function startTrial() {
      centerCircle.style.backgroundColor = "gray";
      centerCircle.innerText = "";
      setTimeout(() => {
        startColorCycle();
      }, 2000); // Initial gray delay
    }

    function startColorCycle() {
      showNextStimulus();
    }

    function showNextStimulus() {
      if (showingFeedback) return;

      clearTimeout(missTimeout);
      inputEnabled = true;

      const colorIndex = Math.floor(Math.random() * colors.length);
      currentColor = colors[colorIndex];
      isGreen = currentColor === "#005000";

      centerCircle.style.backgroundColor = currentColor;
      centerCircle.innerText = "3";

      stimulusShownAt = isGreen ? performance.now() : null;
      awaitingResponse = isGreen;

      if (isGreen) {
        missTimeout = setTimeout(() => {
          if (awaitingResponse) {
            awaitingResponse = false;
            inputEnabled = false;
            sendTrialData(false, null);
            showMessage("Missed!");
          }
        }, 2000);
      }

      // Instead of setInterval, chain next call manually:
      timeoutId = setTimeout(() => {
        if (!showingFeedback) {
          resetAndRestartCycle();
        }
      }, 2000);
    }

    function showMessage(message) {
      showingFeedback = true;
      clearTimeout(missTimeout);
      inputEnabled = false;

      centerCircle.innerText = message;

      setTimeout(() => {
        showingFeedback = false;
        resetAndRestartCycle();
      }, 1000); // 1s feedback duration
    }

    function resetAndRestartCycle() {
      clearTimeout(timeoutId);
      isGreen = false;
      centerCircle.style.backgroundColor = "gray";
      centerCircle.innerText = "";
      setTimeout(() => {
        startColorCycle();
      }, 2000); // 2s gray between trials
    }

    function sendTrialData(isCorrect, rt) {
      liveSend({
        trial_index: trialIndex,
        is_correct: isCorrect,
        reaction_time: rt !== null ? rt.toFixed(2) : null,
      });
      trialIndex++;
    }

    function handleResponse() {
      if (!inputEnabled || showingFeedback) return;
      inputEnabled = false;
      awaitingResponse = false;

      let rt = null;
      let correct = isGreen;

      if (isGreen && stimulusShownAt) {
        rt = performance.now() - stimulusShownAt;
      }

      sendTrialData(correct, rt);
      showMessage(correct ? "Correct!" : "Wrong!");
    }

    centerCircle.addEventListener("click", handleResponse);

    document.addEventListener("keydown", (e) => {
      if (e.key === "3") {
        handleResponse();
      }
    });

    startTrial();
  </script>
</body>

{{ formfields }} {{ next_button }} {{ endblock }}
