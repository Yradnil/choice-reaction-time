{% extends "global/Page.html" %}
{% load otree static %}

{% block title %}
Task
{% endblock %}

{% block content %}
<style>
    html,
    body {
        margin: 0;
        padding: 0;
        height: 100%;
        overflow: hidden;
        font-family: sans-serif;
        background: white;
        color: #111;
        border: 5px solid red;
    }

    #game {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: white;
        z-index: 9999;
    }

    .target {
        position: absolute;
        border-radius: 50%;
        cursor: pointer;
    }

    #info {
        position: absolute;
        top: 10px;
        left: 10px;
        font-size: 18px;
        z-index: 10;
    }

    #startBtn {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 24px;
        padding: 10px 20px;
        cursor: pointer;
        background-color: #333;
        color: white;
        border: none;
        border-radius: 8px;
        z-index: 10000;
    }

    #nextBtn {
        position: absolute;
        top: 60%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 24px;
        padding: 10px 20px;
        cursor: pointer;
        background-color: #333;
        color: white;
        border: none;
        border-radius: 8px;
        display: none;
        z-index: 10000;
    }

    #settings {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 10;
        font-size: 16px;
    }

    #result {
        position: absolute;
        top: 40%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: #222;
        color: white;
        padding: 20px;
        border-radius: 12px;
        font-size: 24px;
        text-align: center;
        display: none;
    }
</style>
</head>

<body>

    <div id="game">
        <div id="info">Targets hit: 0 | Time left: 0.00s</div>


        <div id="result"></div>
        <button id="startBtn" type="button">Start Aim Trainer</button>
        <button id="nextBtn">Next</button>
    </div>

    <script>
        const game = document.getElementById("game");
        const info = document.getElementById("info");
        const startBtn = document.getElementById("startBtn");
        const nextBtn = document.getElementById("nextBtn");
        const result = document.getElementById("result");


        let gameDuration = 30;  // fixed
        let endTime = null;
        let trialIndex = 0;
        let targetsHit = 0;
        let positions = []; // store existing positions to prevent overlap

        let lastSpawnTime = null;   // this will store the timestamp when each red target spawns

        // starts the game
        startBtn.addEventListener("click", () => {
            startGame();
        });

        function random(pMin, pMax) {
            return Math.random() * (pMax - pMin + 1) + pMin;
        }

        function getDistanceFromMouse(x, y, mouseX, mouseY) {
            const dx = x - mouseX;
            const dy = y - mouseY;

            return Math.sqrt(dx * dx + dy * dy);
        }

        function clearTargets() {
            document.querySelectorAll(".target").forEach(el => el.remove());
            positions.length = 0;
        }

        function getWidth(nChoices, distance) {
            const targetTime = 600;
            const a = 100 * Math.log2(nChoices + 1);
            const b = targetTime - a;
            const width = distance / (Math.pow(2, b / 150) - 1);
            return Math.max(10, Math.min(150, width)); // clamp width to keep circles visible
        }

        function isOverlapping(x, y, targetSize) {
            return positions.some(pos => {
                const dist = Math.hypot(pos.x - x, pos.y - y);
                return dist < (pos.targetSize + targetSize) / 2 + 2; // small buffer
            });
        }

        function checkPositions(x, y, targetSize) {
            if (!isOverlapping(x, y, targetSize)) {
                positions.push({ x, y, targetSize });
                return true;
            } else {
                console.log("there is an overlapp");
                return false;
            }
        }

        function spawnTargets() {
            clearTargets();

            const gameRect = game.getBoundingClientRect();
            const n = Math.floor(random(2, 6)); // random number of targets
            const marginRatio = 0.05; //5% inside the game rectangle

            const minX = gameRect.width * marginRatio;
            const maxX = gameRect.width * (1 - marginRatio) - 80;

            const minY = gameRect.height * marginRatio;
            const maxY = gameRect.height * (1 - marginRatio) - 80;
            const colors = ['#FFCC00', '#90D050', '#3C5DAE', '#7A8DBE', '#3DDC84'];
            const shuffledColors = colors.sort(() => 0.5 - Math.random());

            for (let i = 0; i < n; i++) {
                let targetSize;
                const newTarget = document.createElement("div");
                newTarget.classList.add("target");

                // find a nonâ€overlapping (x,y) for this circle
                let x = random(minX, maxX);
                let y = random(minY, maxY);

                // The first element in this loop is the actual target
                if (i === 0) {
                    let distance = getDistanceFromMouse(x, y, event.clientX, event.clientY);
                    targetSize = getWidth(n, distance);
                    positions.push({ x, y, targetSize });
                    newTarget.style.left = `${x - targetSize / 2}px`;
                    newTarget.style.top = `${y - targetSize / 2}px`;

                    newTarget.style.background = "#005000"; //green

                    // record the spawn time, so we can compute response time when clicked
                    lastSpawnTime = performance.now();

                    newTarget.addEventListener("click", (event) => {
                        const responseTime = performance.now() - lastSpawnTime;
                        targetsHit++;
                        updateInfo();

                        // Send overall response time
                        liveSend({ response_time: responseTime, trial_index: trialIndex });

                        const clickX = event.clientX;
                        const clickY = event.clientY;

                        const rtStartTime = performance.now();

                        // records reaction time
                        function onMove(e) {
                            const dx = e.clientX - clickX;
                            const dy = e.clientY - clickY;
                            const dist = Math.sqrt(dx * dx + dy * dy);

                            if (dist > 10) {
                                const rtLeave = performance.now() - rtStartTime;
                                liveSend({ leave_time: rtLeave, trial_index: trialIndex });

                                window.removeEventListener("mousemove", onMove);
                            }
                        }

                        window.addEventListener("mousemove", onMove);
                        trialIndex++;  // increment only after reaction time is captured

                        // Spawn next set of targets immediately after actual target was clicked
                        spawnTargets();
                    });

                } else { //circles that are not the target
                    targetSize = random(30, 80);
                    let attempts = 0;
                    while (attempts < 100) {
                        if (!checkPositions(x, y, targetSize)) {
                            console.log("generate new coords");
                            x = random(minX, maxX);
                            y = random(minY, maxY);
                            attempts++;
                        } else {
                            break;
                        }
                    }
                    newTarget.style.left = `${x - targetSize / 2}px`;
                    newTarget.style.top = `${y - targetSize / 2}px`;

                    const colorIndex = i - 1;
                    newTarget.style.background = shuffledColors[colorIndex]
                }
                newTarget.style.width = `${targetSize}px`;
                newTarget.style.height = `${targetSize}px`;

                game.appendChild(newTarget);
            }
            console.log("Current positions:", positions);
        }

        function updateInfo() {
            const remaining = Math.max(0, ((endTime - performance.now()) / 1000)).toFixed(2);
            info.textContent = `Targets hit: ${targetsHit} | Time left: ${remaining}s`;
        }

        function endGame() {
            clearTargets();

            result.innerHTML = `You hit ${targetsHit} targets in ${gameDuration} seconds!`;
            result.style.display = "block";
            startBtn.style.display = "block";
            nextBtn.style.display = "block";
        }

        function startGame() {
            targetsHit = 0;
            endTime = performance.now() + 30 * 1000;

            startBtn.style.display = "none";
            result.style.display = "none";
            nextBtn.style.display = "none";

            updateInfo();
            spawnTargets();

            intervalId = setInterval(() => {
                updateInfo();
                if (performance.now() >= endTime) {
                    endGame();
                }
            }, 50); // update info every 50 ms
        }
    </script>

    {% formfields %}
    {% endblock %}